<html>
  <head>
    <title>HTML5 Photo Booth</title>
    <script src="http://cdn.polyfill.io/v1/polyfill.js?features=fetch"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/vue/0.11.5/vue.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/javascript-canvas-to-blob/2.2.0/js/canvas-to-blob.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <h2>RethinkDB Photo Booth</h2>

    <video id="live" autoplay></video>
    <canvas id="snapshot" style="display:none"></canvas>

    <img id="image">

    <p><a href="#" onclick="snap()">Take a picture!</a></p>

    <div id="filmroll">
      <div class="photo" v-repeat="photos">
        <p>{{id}}</p>
        <img v-attr="src: path">
      </div>
    </div>

    <script type="text/javascript">
      var app = new Vue({
        el: "body",
        data: {
          photos: []
        },
        ready: function() {
          var socket = io.connect();
          socket.on("photo", function(photo) {
            console.log("New photo:", photo);
            app.addImage(photo);
          });

          fetch("/recent")
          .then(function(output) { return output.json(); })
          .then(function(response) {
            console.log("Output:", response);
            for (var i in response)
              app.addImage(response[i].id);
          });
        },
        methods: {
          addImage: function(id) {
            app.photos.push({id: id, path: "/image/" + id})
          }
        }
      });

      navigator.webkitGetUserMedia({video: true}, function(stream) {
        var video = document.getElementById("live");
        video.src = window.URL.createObjectURL(stream);
      }, function(err) {
        console.log("Failed to get video stream");
      });

      function uploadFile(path, form, cbcomplete, cbprogress) {
        var req = new XMLHttpRequest();
        req.onload = cbcomplete;
        req.upload.onprogress = cbprogress;

        req.open("POST", path, true);
        req.send(form);
      }

      function snap() {
        var live = document.getElementById("live");
        var snapshot = document.getElementById("snapshot");
        var filmroll = document.getElementById("filmroll");

        snapshot.width = live.clientWidth;
        snapshot.height = live.clientHeight;

        var ctx = snapshot.getContext("2d");
        ctx.drawImage(live, 0, 0, snapshot.width, snapshot.height);

        snapshot.toBlob(function(blob) {
          var formData = new FormData();
          formData.append("file", blob, "image.jpg");

          uploadFile("/image/upload", formData,
          function(ev) {
            console.log("Upload complete:", ev.target.response);
          },
          function(ev) {
            console.log("Upload in progress:", ev.loaded, ev.total);
          });

        }, "image/jpg");
      }
    </script>
  </body>
</html>
